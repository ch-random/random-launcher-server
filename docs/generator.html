<html>
  <head>
    <title>manifest.json generator</title>
    <meta charset="UTF-8">
    <style>
      main {
        max-width: 40rem;
        margin-left: auto;
        margin-right: auto;"
      }
      li:has(input) {
        list-style: none;
      }
      input[type="text"], textarea {
        width: 100%;
        padding-top: 0.5em;
        padding-bottom: 0.5em;
      }
      textarea {
        min-height: 6rem;
      }
      section:has(:where(:where(input, textarea)[required]:not(:disabled))) > p::after, :where(label, p):has(+ :where(input, textarea)[required]:not(:disabled))::after{
        content: "*";
        color: red;
      }
      form > section {
        margin-bottom: 2em;
      }
      section.platforms section:has(> label > input) > section {
        margin: 1em;
        margin-left: 2em;
      }
      /*section.platforms > section:has(input[type="radio"]:not(:checked)) > section {
        display: none;
      }*/
      button[type="submit"] {
        width: 100%;
        height: 3em;
        font-size: 3rem;
        appearance: none;
        border-radius: 1rem;
        color: white;
        background-color: #3366ff;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>manifest.json ジェネレータ</h1>
      <button>既存のmanifest.jsonを読み込む...</button>
      <form>
        <section>
          <p>
            製作者(Discord名など部員を特定しやすいものでお願いします)
          </p>
          <input name="author" type="text" required>
        </section>
        <section>
          <p>
            作品名
          </p>
          <input name="name" type="text" required>
        </section>
        <section>
          <p>
            作品の短い説明
          </p>
          <input name="short_description" type="text">
        </section>
        <section>
          <p>
            作品の説明
          </p>
          <textarea name="description"></textarea>
        </section>
        <section>
          <p>作品の種類</p>
          <ul>
            <li>
              <label>
                <input name="content_type" type="radio" value="native" required>
                ネイティブアプリ(Unityなど含む)
              </label>
            </li>
            <li>
              <label>
                <input name="content_type" type="radio" value="webapp" required>
                ウェブサイト/ウェブアプリ
              </label>
            </li>
            <li>
              <label>
                <input name="content_type" type="radio" value="media" required>
                メディア(音楽,イラストなど)
              </label>
            </li>
          </ul>
        </section>
        <section>
          <p>作品カテゴリ</p>
          <ul>
            <li>
              <label>
                <input name="category" type="radio" value="game" required>
                ゲーム
              </label>
            </li>
            <li>
              <label>
                <input name="category" type="radio" value="music" required>
                音楽
              </label>
            </li>
            <li>
              <label>
                <input name="category" type="radio" value="video" required>
                動画
              </label>
            </li>
            <li>
              <label>
                <input name="category" type="radio" value="art" required>
                イラスト等
              </label>
            </li>
            <li>
              <label>
                <input name="category" type="radio" value="common" required>
                その他
              </label>
            </li>
          </ul>
        </section>
        <section>
          <p>
            サムネイル画像のパス
          </p>
          <input name="thumbnail" type="text">
        </section>
        <section>
          <p>
            オプション
          </p>
          <ul>
            <li>
              <label>
                <input name="pad" type="checkbox">
                コントローラー使用可
              </label>
            </li>
            <li>
              <label>
                <input name="esc_exit" type="checkbox" checked>
                Escキーによる強制終了を利用
              </label>
            </li>
        </section>
        <section class="platforms">
          <p>対応プラットフォーム</p>
          <section>
            <label>
              <input name="action-dependency" type="radio" value="independent" checked required>
              プラットフォーム共通
            </label>
            <section>
              <label>実行ファイルのパス/URL</label>
              <input type="text" name="path" required>
            </section>
          </section>
          <section>
            <label>
              <input name="action-dependency" type="radio" value="dependent" required>
              プラットフォーム個別
            </label>
            <section>
              <label>
                <input type="checkbox" name="windows-supported">
                Windows
              </label>
              <section>
                <label>実行ファイルのパス/URL</label>
                <input type="text" name="windows.path" required>
              </section>
            </section>
            <section>
              <label>
                <input type="checkbox" name="macos-supported">
                MacOS
              </label>
              <section>
                <label>実行ファイルのパス/URL</label>
                <input type="text" name="macos.path" required>
              </section>
            </section>
          </section>
        </section>
        <button type="submit">manifest.jsonを生成</button>
      </form>
    </main>
    <script>
      function open_manifest(e) {
        var wait;
        let result;
        if (File.prototype.isPrototypeOf(e)) {
          f_handle = undefined;
          result = new Promise((resolve, reject)=>{resolve(e);});
        } else if (window.FileSystemFileHandle != undefined && FileSystemFileHandle.prototype.isPrototypeOf(e)) {
          f_handle = e;
          result = e.getFile()
        } else if (window.showOpenFilePicker != undefined) {
          wait = showOpenFilePicker().then((e)=>{
            f_handle = e[0];
            result = e[0].getFile();
          });
        } else {
          f_handle = undefined;
          result = new Promise((resolve, reject)=>{
            document.querySelectorAll("input[type=\"file\"][name=\"file-input\"]").forEach((el)=>{
              // make sure that all old file input elements are removed
              el.remove();
            });
            let input = document.createElement("input");
            input.setAttribute("type", "file");
            input.setAttribute("name", "file-input");
            input.style.display = "none";
            document.body.appendChild(input);
            input.addEventListener("input", (e)=>{
              resolve(e.target.files[0]);
              e.target.remove();
            });
            input.addEventListener("cancel", (e)=>{
              // attention: some browsers don't support this event
              reject();
            });
            input.click();
          });
        }
        if (!wait) {
          wait = new Promise((resolve, reject)=>{resolve(undefined);});
        }
        wait.then(async (e)=>{
          try {
            result = await result;
          } catch (error) {
            if (error.name == "AbortError") {
              return;
            }
          }
          let reader = new FileReader();
          reader.readAsText(result);
          reader.addEventListener("load", function() {
            try {
              let data = JSON.parse(reader.result);

              let form = document.forms[0];

              for (let key of [
                "name",
                "author",
                "content_type",
                "category",
                "short_description",
                "description",
                "thumbnail"
              ]) {
                if (Object.hasOwn(data, key)) {
                  form[key].value = data[key];
                } else {
                  form[key].value = "";
                }
              }

              form["pad"].checked = data["pad"] || false;
              form["esc_exit"].checked = data["esc_exit"] || true;

              let supported_platforms = [];
              for (let platform of ["windows", "macos"]) {
                if ((data["supported_platforms"] || []).includes(platform)) {
                  supported_platforms.push(platform);
                  form[`${platform}-supported`].checked = true;
                } else {
                  form[`${platform}-supported`].checked = false;
                }
              }

              if ([0, 2].includes(supported_platforms.length) && (!Object.hasOwn(data, "action") || Object.hasOwn(data["action"], "path"))) {
                form["action-dependency"].value = "independent";
                if (Object.hasOwn(data, "action")) {
                  form["path"].value = data["action"]["path"] || "";
                }
              } else {
                form["action-dependency"].value = "dependent";
                if (Object.hasOwn(data, "action")) {
                  if (Object.hasOwn(data["action"], "path")) {
                    for (let platform of supported_platforms) {
                      form[`${platform}.path`].value = data["action"]["path"];
                    }
                  } else {
                    for (let platform of ["windows", "macos"]) {
                      if (Object.hasOwn(data["action"], platform)) {
                        form[`${platform}-supported`].checked = true;
                        form[`${platform}.path`].value = data["action"][platform]["path"] || "";
                      }
                    }
                  }
                }
              }
              form.querySelector(`input[value=\"${form["action-dependency"].value}\"]`).dispatchEvent(new Event("change"));
            } catch (e) {
              window.alert(`読み込みに失敗しました\nエラー: ${e}`);
            }
          }, {once: true});
        });
      }

      document.querySelector("main > button").addEventListener("click", open_manifest);


      for (let sec of document.querySelectorAll("section.platforms section:has(> label:first-child > input:where([type=\"checkbox\"], [type=\"radio\"]))")) {
        let input = sec.querySelector("& > label:first-child > input:where([type=\"checkbox\"], [type=\"radio\"])");
        let children = sec.querySelectorAll("& > section > input, & > section:not(:has(> label:first-child > input)) input, & > section > label > input");

        input.onchange = (e)=>{
          if (e.target.type == "radio" && e.target.checked) {
            e.target.form.elements.namedItem(e.target.name).forEach((el)=>{
              if (el != e.target && el.onchange) {
                el.onchange({target: el});
              }
            });
          }
          children.forEach((el)=>{
            el.disabled = !e.target.checked || e.target.disabled;
            if (el.onchange) {
              el.onchange({target: el});
            }
          });
        };

        input.onchange({target: input});
      }

      document.forms[0].addEventListener("submit", (e)=>{
        let data = new FormData(e.target);
        e.preventDefault();

        let result = {
          name: data.get("name"),
          author: data.get("author"),
          content_type: data.get("content_type"),
          category: data.get("category"),
          pad: data.get("pad") == "on",
          esc_exit: data.get("esc_exit") == "on",
          supported_platforms: []
        };

        for (let opt of [
          "short_description",
          "description",
          "thumbnail"
        ]) {
          if (data.get(opt)) {
            result[opt] = data.get(opt);
          }
        }

        if (data.get("action-dependency") == "independent") {
          result["action"] = {
            path: data.get("path")
          };
        } else { // platform dependent
          result["action"] = {};

          for (let platform of ["windows", "macos"]) {
            if (data.get(`${platform}-supported`)) {
              result["supported_platforms"].push(platform);
              result["action"][platform] = {
                "path": data.get(`${platform}.path`)
              };
            }
          }
        }

        let blob;
        blob = new Blob([JSON.stringify(result, null, 2)], {type: "application/json"});
        let anchor = document.createElement("a");
        let url = URL.createObjectURL(blob);
        anchor.download = "manifest.json";
        anchor.href = url;
        anchor.style.display = "none";
        document.body.appendChild(anchor);
        anchor.click();
        window.addEventListener("pagehide", (e)=>{URL.revokeObjectURL(url);}, {once:true, passive:true});
      });
      window.addEventListener('beforeunload', (e)=>{
        try{
          e.preventDefault();
          e.returnValue = "";
        } catch {}
      });
    </script>
  </body>
</html>